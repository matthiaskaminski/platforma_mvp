
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  ADMIN
  DESIGNER
  CLIENT
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  COMPLETED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum RoomType {
  LIVING   @map("living")
  KITCHEN  @map("kitchen")
  BEDROOM  @map("bedroom")
  BATHROOM @map("bathroom")
  KIDS     @map("kids")
  HALL     @map("hall")
  OFFICE   @map("office")
  OTHER    @map("other")
}

// Product planning status (lifecycle)
enum ProductPlanningStatus {
  LIKED         @map("liked")
  MAIN          @map("main")
  VARIANT       @map("variant")
  APPROVED      @map("approved")
  REJECTED      @map("rejected")
}

// Product fulfillment status (after approval)
enum ProductStatus {
  TO_ORDER      @map("to_order")
  ORDERED       @map("ordered")
  PAID          @map("paid")
  DELIVERED     @map("delivered")
  RETURNED      @map("returned")
}

// Service category type
enum ServiceCategory {
  MATERIAL      @map("material")
  LABOR         @map("labor")
}

// Service planning status (lifecycle)
enum ServicePlanningStatus {
  DRAFT         @map("draft")       // Draft - not in budget
  PLANNED       @map("planned")     // Planned - in estimated budget
  APPROVED      @map("approved")    // Approved - in real budget
  REJECTED      @map("rejected")    // Rejected
}

// Material fulfillment status (after approval)
enum MaterialStatus {
  TO_ORDER        @map("to_order")        // To order
  ORDERED         @map("ordered")         // Ordered
  TO_PAY          @map("to_pay")          // To pay
  PAID            @map("paid")            // Paid
  ADVANCE_PAID    @map("advance_paid")    // Advance paid
  RECEIVED        @map("received")        // Received
  COMPLETED       @map("completed")       // Completed
}

// Labor fulfillment status (after approval)
enum LaborStatus {
  TO_ORDER        @map("to_order")        // To order
  ORDERED         @map("ordered")         // Ordered
  PAID            @map("paid")            // Paid
  IN_PROGRESS     @map("in_progress")     // In progress
  COMPLETED       @map("completed")       // Completed
}

enum RoomStatus {
  NOT_STARTED @map("not_started")
  IN_PROGRESS @map("in_progress")
  FINISHED    @map("finished")
}

model Profile {
  id          String   @id @default(uuid()) @db.Uuid
  email       String   @unique
  fullName    String?  @map("full_name")
  avatarUrl   String?  @map("avatar_url")
  phoneNumber String?  @map("phone_number")
  role        UserRole @default(DESIGNER)

  // New onboarding fields
  studioName  String?  @map("studio_name")
  nip         String?

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  projects    Project[]
  wishlists   Wishlist[]
  gmailToken  GmailToken?

  @@index([email])
  @@map("profiles")
}

model GmailToken {
  id            String   @id @default(uuid()) @db.Uuid
  profileId     String   @unique @map("profile_id") @db.Uuid
  profile       Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  accessToken   String   @map("access_token")
  refreshToken  String   @map("refresh_token")
  expiresAt     DateTime @map("expires_at")
  gmailEmail    String   @map("gmail_email")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("gmail_tokens")
}

model Client {
  id          String   @id @default(uuid()) @db.Uuid
  email       String
  fullName    String?  @map("full_name")
  phoneNumber String?  @map("phone_number")
  nip         String?

  projectId   String   @map("project_id") @db.Uuid
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@map("clients")
}

model Project {
  id          String   @id @default(uuid()) @db.Uuid
  designerId  String   @map("designer_id") @db.Uuid
  designer    Profile  @relation(fields: [designerId], references: [id], onDelete: Cascade)

  name        String
  description String?
  status      ProjectStatus @default(DRAFT)

  // New visual fields
  icon        String?
  color       String?
  coverImage  String?  @map("cover_image")

  // Address / Details
  address     String?
  city        String?
  postalCode  String?  @map("postal_code")

  totalArea   Float?   @map("total_area")
  floorsCount Int?     @map("floors_count")
  roomsCount  Int?     @map("rooms_count")
  budgetGoal  Decimal? @map("budget_goal") @db.Decimal(12, 2)

  startDate   DateTime? @map("start_date")
  deadline    DateTime?

  // Relations
  rooms       Room[]
  clients     Client[]
  contacts    Contact[]
  conversations Conversation[]
  surveys     Survey[]
  moodboards  Moodboard[]
  sprints     Sprint[]    @relation("ProjectSprints")
  tasks       Task[]      @relation("ProjectTasks")
  documents   Document[]  @relation("ProjectDocuments")
  calendarEvents CalendarEvent[]
  serviceItems ServiceItem[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([designerId])
  @@map("projects")
}

model Room {
  id          String   @id @default(uuid()) @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name        String
  type        RoomType @default(OTHER)
  status      RoomStatus @default(NOT_STARTED)
  area        Float?
  floorNumber Int?     @map("floor_number")
  budgetAllocated Decimal? @map("budget_allocated") @db.Decimal(12, 2)
  coverImage  String?  @map("cover_image")

  // Relations
  productItems ProductItem[]
  galleryImages GalleryImage[]
  tasks       Task[]      @relation("RoomTasks")
  sprints     Sprint[]    @relation("RoomSprints")
  notes       Note[]
  serviceItems ServiceItem[]

  @@index([projectId])
  @@map("rooms")
}

model Wishlist {
  id          String   @id @default(uuid()) @db.Uuid
  designerId  String   @map("designer_id") @db.Uuid
  designer    Profile  @relation(fields: [designerId], references: [id], onDelete: Cascade)
  name        String

  // Relations
  productItems ProductItem[]

  createdAt   DateTime @default(now()) @map("created_at")

  @@index([designerId])
  @@map("wishlists")
}

model ProductItem {
  id          String   @id @default(uuid()) @db.Uuid

  wishlistId  String?  @map("wishlist_id") @db.Uuid
  wishlist    Wishlist? @relation(fields: [wishlistId], references: [id], onDelete: SetNull)

  roomId      String?  @map("room_id") @db.Uuid
  room        Room?    @relation(fields: [roomId], references: [id], onDelete: SetNull)

  name        String
  category    String?
  supplier    String?
  url         String?
  imageUrl    String?  @map("image_url")

  price       Decimal  @default(0) @db.Decimal(12, 2)
  quantity    Int      @default(1)
  paidAmount  Decimal  @default(0) @map("paid_amount") @db.Decimal(12, 2)

  planningStatus ProductPlanningStatus @default(LIKED) @map("planning_status")
  status      ProductStatus @default(TO_ORDER)
  isInCart    Boolean  @default(false) @map("is_in_cart")

  notes       String?

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([wishlistId])
  @@index([roomId])
  @@index([planningStatus])
  @@map("product_items")
}

model Sprint {
  id          String   @id @default(uuid()) @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  project     Project  @relation("ProjectSprints", fields: [projectId], references: [id], onDelete: Cascade)

  roomId      String?  @map("room_id") @db.Uuid
  room        Room?    @relation("RoomSprints", fields: [roomId], references: [id], onDelete: SetNull)

  name        String
  goal        String?
  status      SprintStatus @default(PLANNED)

  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")

  // Relations
  tasks       Task[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([roomId])
  @@map("sprints")
}

model Task {
  id          String   @id @default(uuid()) @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  project     Project  @relation("ProjectTasks", fields: [projectId], references: [id], onDelete: Cascade)

  sprintId    String?  @map("sprint_id") @db.Uuid
  sprint      Sprint?  @relation(fields: [sprintId], references: [id], onDelete: SetNull)

  roomId      String?  @map("room_id") @db.Uuid
  room        Room?    @relation("RoomTasks", fields: [roomId], references: [id], onDelete: SetNull)

  title       String
  description String?
  status      TaskStatus @default(TODO)

  // AssignedTo typically refers to a Profile or user ID, which should be UUID too if users are in Profile
  assignedTo  String?  @map("assigned_to") @db.Uuid
  dueDate     DateTime? @map("due_date")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([sprintId])
  @@index([roomId])
  @@map("tasks")
}

// Additional models for context (simplified)
model Contact {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String
  role      String?
  email     String?
  phone     String?
  @@index([projectId])
  @@map("contacts")
}

model Conversation {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  messages  Message[]
  @@index([projectId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid()) @db.Uuid
  conversationId String       @map("conversation_id") @db.Uuid
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  content        String
  senderId       String       @map("sender_id") @db.Uuid // Profile ID
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("messages")
}

model Survey {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title     String
  status    String   @default("DRAFT")
  @@index([projectId])
  @@map("surveys")
}

model Moodboard {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String
  images    Json?
  @@index([projectId])
  @@map("moodboards")
}

model Document {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  project   Project  @relation("ProjectDocuments", fields: [projectId], references: [id], onDelete: Cascade)
  name      String
  url       String
  type      String?
  size      Int?
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  @@index([projectId])
  @@map("documents")
}

model Note {
  id        String   @id @default(uuid()) @db.Uuid
  roomId    String   @map("room_id") @db.Uuid
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  @@index([roomId])
  @@map("notes")
}

model CalendarEvent {
  id          String   @id @default(uuid()) @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  date        DateTime
  description String?
  type        String   @default("MEETING") // MEETING, DEADLINE, PAYMENT, INSTALLATION
  @@index([projectId])
  @@map("calendar_events")
}

model GalleryImage {
  id        String   @id @default(uuid()) @db.Uuid
  roomId    String   @map("room_id") @db.Uuid
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  url       String
  caption   String?
  createdAt DateTime @default(now()) @map("created_at")
  @@index([roomId])
  @@map("gallery_images")
}

// Services - Materials and Labor
model ServiceItem {
  id            String   @id @default(uuid()) @db.Uuid
  projectId     String   @map("project_id") @db.Uuid
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  roomId        String?  @map("room_id") @db.Uuid
  room          Room?    @relation(fields: [roomId], references: [id], onDelete: SetNull)

  // Common fields
  category      ServiceCategory @default(MATERIAL)
  planningStatus ServicePlanningStatus @default(DRAFT) @map("planning_status")

  // Material specific fields
  name          String?          // Material name
  unit          String?          // Unit (e.g. m2, pcs, kg)
  quantity      Float?           // Quantity
  price         Decimal @default(0) @db.Decimal(12, 2)  // Total price
  imageUrl      String?  @map("image_url")
  url           String?          // Product link
  materialType  String?  @map("material_type")  // Material type
  materialStatus MaterialStatus? @default(TO_ORDER) @map("material_status")

  // Labor specific fields
  subcontractor String?          // Subcontractor
  scope         String?          // Work scope
  duration      String?          // Duration
  laborStatus   LaborStatus? @default(TO_ORDER) @map("labor_status")

  notes         String?

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([roomId])
  @@index([category])
  @@index([planningStatus])
  @@map("service_items")
}
